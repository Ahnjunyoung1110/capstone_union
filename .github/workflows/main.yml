name: Build the front and back with push

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ (ì„œë¸Œëª¨ë“ˆ í¬í•¨)
      - name: Checkout with submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive
          token: ${{ secrets.FRONT_PAT }}

      # 2. Docker Build - ë°±ì—”ë“œ
      - name: Build Backend Image
        run: |
          docker build -t my-backend ./backend

      # 3. Docker Build - í”„ë¡ íŠ¸ì—”ë“œ
      - name: Build Frontend Image
        run: |
          docker build -t my-frontend ./frontend

      # 4. Docker Save - tarë¡œ ì €ì¥
      - name: Save Images to tar
        run: |
          docker save -o backend.tar my-backend
          docker save -o frontend.tar my-frontend
          chmod 644 backend.tar frontend.tar

          
      # 5) tar íŒŒì¼ EC2ë¡œ ë³µì‚¬ (SSH/SCP)
      #    SSH ê°œì¸í‚¤Â·í˜¸ìŠ¤íŠ¸Â·ì‚¬ìš©ìëª…ì€ GitHub Secrets ë¡œ ë³´ê´€
      - name: Copy images to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ secrets.EC2_HOST }}        # ì˜ˆ: "13.124.xxx.xxx"
          username: ${{ secrets.EC2_USER }}        # ì˜ˆ: "ec2-user" or "ubuntu"
          key:      ${{ secrets.EC2_SSH_KEY }}     # PEM ê°œì¸í‚¤
          port:     22
          source:   "backend.tar,frontend.tar ,compose.yaml"
          target:   "~/deploy/"                    # EC2 ë‚´ ë°°í¬ ë””ë ‰í„°ë¦¬
    
      # 6) EC2 ë‚´ë¶€ì—ì„œ Docker ì´ë¯¸ì§€ ë¡œë“œ + ì»¨í…Œì´ë„ˆ(ë˜ëŠ” compose) ì¬ì‹œì‘
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.8
        with:
          host:     ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key:      ${{ secrets.EC2_SSH_KEY }}
          port:     22
          script: |
            set -e
            cd ~/deploy
    
            echo "ğŸ›   Docker image load"
            docker load -i backend.tar
            docker load -i frontend.tar

            echo "ğŸ§¹ Stop and remove old containers (if exist)"
            docker rm -f backend frontend || true
    
            echo "â™»ï¸  Restart containers"
            # ğŸ‘‰ ë°©ë²• 1) docker compose ì‚¬ìš©
            docker compose down   || true
            docker compose up -d --force-recreate

    
            echo "âœ…  Deploy done"

